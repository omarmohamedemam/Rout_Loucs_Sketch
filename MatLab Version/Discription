This is the same algorthim impelmented in matlab
